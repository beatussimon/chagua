{% extends 'core/base.html' %}
{% load i18n %}
{% block title %}{% trans "Messages" %}{% endblock %}
{% block content %}
    <h1 class="text-2xl font-bold mb-6">{% trans "Messages" %}</h1>
    {% if user.is_authenticated %}
        <div class="card flex flex-col md:flex-row">
            <div class="w-full md:w-1/3 border-r">
                <h2 class="text-xl mb-4">{% trans "Conversations" %}</h2>
                {% for group in groups %}
                    <a href="{% url 'messaging_group' group.id %}" class="block p-2 {% if group == current_group %}bg-gray-200{% endif %}">{{ group.name }}</a>
                {% endfor %}
                {% for user in users %}
                    <a href="{% url 'messaging' %}?recipient={{ user.id }}" class="block p-2 {% if user.id|stringformat:'s' == request.GET.recipient %}bg-gray-200{% endif %}">{{ user.username }}</a>
                {% endfor %}
            </div>
            <div class="w-full md:w-2/3 p-4" data-group-id="{{ current_group.id|default:'' }}">
                <div id="messages" class="h-96 overflow-y-auto mb-4">
                    {% for message in sent %}
                        <p><strong>{{ message.sender }}:</strong> {{ message.content }} ({{ message.timestamp }}) {% if message.attachment %}<a href="{{ message.attachment.url }}" class="text-blue-500">{% trans "Attachment" %}</a>{% endif %}</p>
                    {% endfor %}
                    {% for message in received %}
                        <p><strong>{{ message.sender }}:</strong> {{ message.content }} ({{ message.timestamp }}) {% if message.attachment %}<a href="{{ message.attachment.url }}" class="text-blue-500">{% trans "Attachment" %}</a>{% endif %}</p>
                    {% endfor %}
                </div>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% if current_group %}
                        <input type="hidden" name="group_id" value="{{ current_group.id }}">
                    {% else %}
                        <input type="hidden" name="recipient_id" value="{{ request.GET.recipient }}">
                    {% endif %}
                    <select name="template" onchange="this.form.querySelector('textarea').value = this.options[this.selectedIndex].dataset.content" class="border p-2 rounded w-full mb-2">
                        <option value="">{% trans "Select Template" %}</option>
                        {% for template in templates %}
                            <option value="{{ template.id }}" data-content="{{ template.content }}">{{ template.content|truncatechars:20 }}</option>
                        {% endfor %}
                    </select>
                    {{ form.as_p }}
                    <input type="datetime-local" name="schedule" class="border p-2 rounded w-full mb-2" placeholder="{% trans 'Schedule (optional)' %}">
                    <button type="submit" class="button">{% trans "Send" %}</button>
                    <button type="submit" name="template" class="button ml-2">{% trans "Save as Template" %}</button>
                </form>
            </div>
        </div>
    {% else %}
        <div class="card">
            <p>{% trans "Please log in to access messaging." %}</p>
            <a href="{% url 'login' %}" class="button mt-4">{% trans "Login" %}</a>
        </div>
    {% endif %}
{% endblock %}