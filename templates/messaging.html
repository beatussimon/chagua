{% extends 'base.html' %}
{% load static %}
{% block title %}Messages{% endblock %}
{% block content %}
    <h1 class="text-4xl font-extrabold mb-8">Messages</h1>
    <div class="flex space-x-8">
        <aside class="w-1/3 bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Conversations</h2>
                <a href="{% url 'new_conversation' %}" class="text-blue-500 hover:text-blue-600" aria-label="New conversation">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </a>
            </div>
            <select class="w-full p-2 mb-4 border rounded" onchange="filterMessages(this.value)">
                {% for filter in filters %}
                    <option value="{{ filter }}">{{ filter|title }}</option>
                {% endfor %}
            </select>
            <ul id="conversation-list" class="space-y-2 max-h-96 overflow-y-auto">
                {% for conv in conversations %}
                    <li class="p-3 rounded-lg hover:bg-gray-100 transition-colors {% if conv.id == conversation.id %}bg-blue-100{% endif %}">
                        <a href="{% url 'messaging' conv.id %}" class="flex justify-between">
                            <span>
                                {% if conv.is_group %}
                                    {{ conv.name }}
                                {% else %}
                                    {% for participant in conv.participants.all %}
                                        {% if participant != request.user %}
                                            {{ participant.username }}{% if not forloop.last %}, {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </span>
                            <span class="text-sm text-gray-500">{{ conv.messages.last.timestamp|date:"H:i" }}</span>
                        </a>
                    </li>
                {% empty %}
                    <li class="text-gray-500">No conversations yet.</li>
                {% endfor %}
            </ul>
        </aside>
        <section class="w-2/3 bg-white p-6 rounded-xl shadow-lg">
            {% if conversation %}
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">
                        {% if conversation.is_group %}
                            {{ conversation.name }}
                        {% else %}
                            {% for participant in conversation.participants.all %}
                                {% if participant != request.user %}
                                    {{ participant.username }}{% if not forloop.last %}, {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </h2>
                </div>
                <div id="chat-box" class="h-96 overflow-y-auto mb-6 p-4 border rounded-lg bg-gray-50">
                    {% for message in messages %}
                        <div class="mb-2 {% if message.sender == request.user %}text-right{% endif %}">
                            <p class="inline-block p-3 rounded-lg {% if message.sender == request.user %}bg-blue-500 text-white{% else %}bg-gray-200{% endif %}">
                                <span class="font-medium">{{ message.sender.username }}:</span> {{ message.content }}
                            </p>
                            <p class="text-xs text-gray-500 mt-1">{{ message.timestamp|date:"H:i, d M Y" }}{% if message.is_read %} - Read{% endif %}</p>
                        </div>
                    {% endfor %}
                </div>
                <form method="post" class="flex space-x-2">
                    {% csrf_token %}
                    {{ form.content }}
                    <button type="submit" class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors" aria-label="Send message">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </form>
            {% else %}
                <p class="text-center text-gray-500">Select a conversation to start chatting.</p>
            {% endif %}
        </section>
    </div>
    <script src="{% static 'js/ui.js' %}"></script>
{% endblock %}